!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t()):e.onScan=t()}(this,function(){var e={attachTo:function(t,n){if(void 0!==t.scannerDetectionData)throw Error("onScan.js is already initialized for DOM element "+t);return n=this._mergeOptions({onScan:function(e,t){},onScanError:function(e){},onKeyProcess:function(e,t){},onKeyDetect:function(e,t){},onPaste:function(e,t){},keyCodeMapper:function(t){return e.decodeKeyEvent(t)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1},n),t.scannerDetectionData={options:n,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},!0===n.reactToPaste&&t.addEventListener("paste",this._handlePaste,n.captureEvents),!1!==n.scanButtonKeyCode&&t.addEventListener("keyup",this._handleKeyUp,n.captureEvents),(!0===n.reactToKeydown||!1!==n.scanButtonKeyCode)&&t.addEventListener("keydown",this._handleKeyDown,n.captureEvents),this},detachFrom:function(e){e.scannerDetectionData.options.reactToPaste&&e.removeEventListener("paste",this._handlePaste),!1!==e.scannerDetectionData.options.scanButtonKeyCode&&e.removeEventListener("keyup",this._handleKeyUp),e.removeEventListener("keydown",this._handleKeyDown),e.scannerDetectionData=void 0},getOptions:function(e){return e.scannerDetectionData.options},setOptions:function(e,t){switch(e.scannerDetectionData.options.reactToPaste){case!0:!1===t.reactToPaste&&e.removeEventListener("paste",this._handlePaste);break;case!1:!0===t.reactToPaste&&e.addEventListener("paste",this._handlePaste)}return!1===e.scannerDetectionData.options.scanButtonKeyCode?!1!==t.scanButtonKeyCode&&e.addEventListener("keyup",this._handleKeyUp):!1===t.scanButtonKeyCode&&e.removeEventListener("keyup",this._handleKeyUp),e.scannerDetectionData.options=this._mergeOptions(e.scannerDetectionData.options,t),this._reinitialize(e),this},decodeKeyEvent:function(e){var t=this._getNormalizedKeyNum(e);switch(!0){case t>=48&&t<=90:case t>=160&&t<=165:case t>=169&&t<=173:case t>=186&&t<=223:case 226===t:case t>=106&&t<=111:return this.decodeKey(e)}return""},decodeKey:function(e){let t={51:{shiftKeyTrue:"#",shiftKeyFalse:"3"},65:{shiftKeyTrue:"A",shiftKeyFalse:"a"},66:{shiftKeyTrue:"B",shiftKeyFalse:"b"},67:{shiftKeyTrue:"C",shiftKeyFalse:"c"},68:{shiftKeyTrue:"D",shiftKeyFalse:"d"},69:{shiftKeyTrue:"E",shiftKeyFalse:"e"},70:{shiftKeyTrue:"F",shiftKeyFalse:"f"},71:{shiftKeyTrue:"G",shiftKeyFalse:"g"},72:{shiftKeyTrue:"H",shiftKeyFalse:"h"},73:{shiftKeyTrue:"I",shiftKeyFalse:"i"},74:{shiftKeyTrue:"J",shiftKeyFalse:"j"},75:{shiftKeyTrue:"K",shiftKeyFalse:"k"},76:{shiftKeyTrue:"L",shiftKeyFalse:"l"},77:{shiftKeyTrue:"M",shiftKeyFalse:"m"},78:{shiftKeyTrue:"N",shiftKeyFalse:"n"},79:{shiftKeyTrue:"O",shiftKeyFalse:"o"},80:{shiftKeyTrue:"P",shiftKeyFalse:"p"},81:{shiftKeyTrue:"Q",shiftKeyFalse:"q"},82:{shiftKeyTrue:"R",shiftKeyFalse:"r"},83:{shiftKeyTrue:"S",shiftKeyFalse:"s"},84:{shiftKeyTrue:"T",shiftKeyFalse:"t"},85:{shiftKeyTrue:"U",shiftKeyFalse:"u"},86:{shiftKeyTrue:"V",shiftKeyFalse:"v"},87:{shiftKeyTrue:"W",shiftKeyFalse:"w"},88:{shiftKeyTrue:"X",shiftKeyFalse:"x"},89:{shiftKeyTrue:"Y",shiftKeyFalse:"y"},90:{shiftKeyTrue:"Z",shiftKeyFalse:"z"},186:{shiftKeyTrue:"^",shiftKeyFalse:""},188:{shiftKeyTrue:"<",shiftKeyFalse:","},190:{shiftKeyTrue:">",shiftKeyFalse:"."},191:{shiftKeyTrue:"&",shiftKeyFalse:"/"},192:{shiftKeyTrue:"~",shiftKeyFalse:"`"},219:{shiftKeyTrue:"{",shiftKeyFalse:"["},220:{shiftKeyTrue:"|",shiftKeyFalse:'"'},221:{shiftKeyTrue:"}",shiftKeyFalse:"]"},222:{shiftKeyTrue:'"',shiftKeyFalse:""}}[e.keyCode];return void 0===t?e.key:!0===e.shiftKey?t.shiftKeyTrue:t.shiftKeyFalse},simulate:function(e,t){return this._reinitialize(e),Array.isArray(t)?t.forEach(function(e){var t={};("object"==typeof e||"function"==typeof e)&&null!==e?t=e:t.keyCode=parseInt(e);var n=new KeyboardEvent("keydown",t);document.dispatchEvent(n)}):this._validateScanCode(e,t),this},_reinitialize:function(e){var t=e.scannerDetectionData.vars;t.firstCharTime=0,t.lastCharTime=0,t.accumulatedString=""},_isFocusOnIgnoredElement:function(e){var t=e.scannerDetectionData.options.ignoreIfFocusOn;if(!t)return!1;var n=document.activeElement;if(Array.isArray(t)){for(var s=0;s<t.length;s++)if(!0===n.matches(t[s]))return!0}else if(n.matches(t))return!0;return!1},_validateScanCode:function(t,n){var s,a=t.scannerDetectionData,i=a.options,r=a.options.singleScanQty,o=a.vars.firstCharTime,c=a.vars.lastCharTime,h={};switch(!0){case n.length<i.minLength:h={message:"Received code is shorter than minimal length"};break;case c-o>n.length*i.avgTimeByChar:h={message:"Received code was not entered in time"};break;default:return i.onScan.call(t,n,r),s=new CustomEvent("scan",{detail:{scanCode:n,qty:r}}),t.dispatchEvent(s),e._reinitialize(t),!0}return h.scanCode=n,h.scanDuration=c-o,h.avgTimeByChar=i.avgTimeByChar,h.minLength=i.minLength,i.onScanError.call(t,h),s=new CustomEvent("scanError",{detail:h}),t.dispatchEvent(s),e._reinitialize(t),!1},_mergeOptions:function(e,t){var n,s={};for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&(s[n]=e[n]);for(n in t)Object.prototype.hasOwnProperty.call(t,n)&&(s[n]=t[n]);return s},_getNormalizedKeyNum:function(e){return e.which||e.keyCode},_handleKeyDown:function(t){var n=e._getNormalizedKeyNum(t),s=this.scannerDetectionData.options,a=this.scannerDetectionData.vars,i=!1;if(!(!1===s.onKeyDetect.call(this,n,t)||e._isFocusOnIgnoredElement(this))){if(!1!==s.scanButtonKeyCode&&n==s.scanButtonKeyCode){a.longPressed||(a.longPressTimer=setTimeout(s.onScanButtonLongPress,s.scanButtonLongPressTime,this),a.longPressed=!0);return}switch(!0){case a.firstCharTime&&-1!==s.suffixKeyCodes.indexOf(n):t.preventDefault(),t.stopImmediatePropagation(),i=!0;break;case!a.firstCharTime&&-1!==s.prefixKeyCodes.indexOf(n):t.preventDefault(),t.stopImmediatePropagation(),i=!1;break;default:var r=s.keyCodeMapper.call(this,t);if(null===r)return;a.accumulatedString+=r,s.preventDefault&&t.preventDefault(),s.stopPropagation&&t.stopImmediatePropagation(),i=!1}a.firstCharTime||(a.firstCharTime=Date.now()),a.lastCharTime=Date.now(),a.testTimer&&clearTimeout(a.testTimer),i?(e._validateScanCode(this,a.accumulatedString),a.testTimer=!1):a.testTimer=setTimeout(e._validateScanCode,s.timeBeforeScanTest,this,a.accumulatedString),s.onKeyProcess.call(this,r,t)}},_handlePaste:function(t){var n=this.scannerDetectionData.options,s=this.scannerDetectionData.vars,a=(event.clipboardData||window.clipboardData).getData("text");!e._isFocusOnIgnoredElement(this)&&(t.preventDefault(),n.stopPropagation&&t.stopImmediatePropagation(),n.onPaste.call(this,a,event),s.firstCharTime=0,s.lastCharTime=0,e._validateScanCode(this,a))},_handleKeyUp:function(t){!e._isFocusOnIgnoredElement(this)&&e._getNormalizedKeyNum(t)==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)},isScanInProgressFor:function(e){return e.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(e){return void 0!==e.scannerDetectionData}};return e});